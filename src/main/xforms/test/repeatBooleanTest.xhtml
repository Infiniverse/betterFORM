<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xf="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.w3.org/2002/xforms ">
<head>
    <title>TimeTracker</title>

    <script type="text/javascript">
        dojo.require("dijit.dijit"); // optimize: load dijit layer
        dojo.require("dijit.layout.BorderContainer");
    </script>

    <style type="text/css">
        .header {
            font-size: 16pt;
            color: gray;
            border-bottom: thin solid gray;
        }

        tr.xfRepeatHeader  td {
            font-weight: bold;
            padding-right: 5px;
        }

        .caTabContainer {
            overflow: hidden;
        }

        tr.xfRepeatItem  td {
            padding-right: 5px;
        }

        /* date column */
        .caTableCol-1 {
            text-align: left;
            width: 11ex;
        }

        /* time column */
        .caTableCol-2 {
            text-align: right;
        }

        /* time column */
        .caTableCol-3 {
            text-align: left;
        }

        /* time column */
        .caTableCol-4 {
            text-align: left;
        }

        /* note column */
        .caTableCol-5 {
            overflow: hidden;
        }

        /* time column */
        .caTableCol-6 {
            text-align: left;
        }

        /* time column */
        .caTableCol-7 {
            text-align: right;
        }

        #task-table span.xfControl {
            display: block;
            margin-left: 5px;
        }

        /*.subheader {*/
            /*font-size: 14pt;*/
            /*color: gray;*/
            /*border-bottom: thin solid gray;*/
            /*margin-bottom: 30px;*/

        /*}*/

        /*.xfControl {*/
            /*padding: 4px;*/
        /*}*/

        /*#errorReport-value {*/
            /*border: thin solid;*/
            /*display: block;*/
            /*background: red;*/
        /*}*/

        /*#caCopyright {*/
            /*bottom: 5px;*/
        /*}*/
    </style>
</head>
<body>
<div style="display:none">
    <xf:model>

        <xf:instance id="i-task">
            <data xmlns="">
                <task>
                    <date/>
                    <project/>
                    <start/>
                    <end/>
                    <duration hours="0" minutes="0"/>
                    <who/>
                    <what/>
                    <note/>
                    <billable/>
                    <billed date=""/>
                    <status/>
                    <created/>
                </task>
            </data>
        </xf:instance>


        <xf:bind nodeset="task">
            <xf:bind nodeset="date" type="xf:date"/>
            <!--
				<xf:bind nodeset="start" type="xf:time" constraint=". &lt; ../end"/>
				<xf:bind nodeset="end" type="xf:time" constraint=". &gt; ../start"/>
-->
            <xf:bind nodeset="duration/@hours" type="integer" constraint=". != 0 or ../@minutes != 0"/>
            <xf:bind nodeset="duration/@minutes" type="integer" constraint=". != 0 or ../@hours != 0"/>
            <xf:bind nodeset="who" required="true()"/>
            <xf:bind nodeset="what" required="true()"/>
            <xf:bind nodeset="billable" type="xf:boolean"/>
            <xf:bind nodeset="billed" type="xf:boolean"/>
            <xf:bind nodeset="billed/@date" type="xf:date"/>
            <xf:bind nodeset="created" type="xf:dateTime" required="true()"/>
        </xf:bind>

        <xf:instance id="i-task-empty">
            <data xmlns="">
                <task>
                    <date/>
                    <project/>
                    <start/>
                    <end/>
                    <duration hours="0" minutes="0"/>
                    <who/>
                    <what/>
                    <note/>
                    <billable>false</billable>
                    <billed date=""/>
                    <status/>
                    <created/>
                </task>
            </data>
        </xf:instance>

        <xf:instance id="i-tasks">
            <data xmlns="">

            </data>
        </xf:instance>

        <xf:bind nodeset="instance('i-tasks')/project/task">
            <xf:bind nodeset="billable" type="xf:boolean"/>
        </xf:bind>

        <xf:instance id="i-query-tasks">
            <data xmlns="">
                <project/>
            </data>
        </xf:instance>

        <xf:instance id="i-project"
                     src="http://golem.local:8080/exist/rest/db/timetracking/i-project.xml"/>

        <xf:instance id="i-who"
                     src="http://golem.local:8080/exist/rest/db/timetracking/i-who.xml" />

        <xf:instance id="i-controller">
            <data xmlns="">
                <error hasError="false"><![CDATA[]]></error>
                <timestamp/>
            </data>
        </xf:instance>
        <xf:bind nodeset="instance('i-controller')/error" relevant="@hasError='true'"/>

        <xf:submission id="s-add"
                       resource="http://golem.local:8080/exist/rest/db/timetracking/tasks/task/{instance('i-controller')/timestamp}.xml"
                       method="put"
                       replace="none">
            <xf:action ev:event="xforms-submit">
                <xf:message level="ephemeral">Creating timestamp</xf:message>
                <xf:setvalue ref="instance('i-task')/task/created" value="adjust-dateTime-to-timezone(now())"/>
                <xf:setvalue ref="instance('i-controller')/timestamp" value="concat(
                    year-from-dateTime(instance('i-task')/task/created),
                    IF( month-from-dateTime(instance('i-task')/task/created) &gt; 9,
                        month-from-dateTime(instance('i-task')/task/created),
                        concat('0', month-from-dateTime(instance('i-task')/task/created))
                    ),
                    IF( day-from-dateTime(instance('i-task')/task/created) &gt; 9,
                        day-from-dateTime(instance('i-task')/task/created),
                        concat('0', day-from-dateTime(instance('i-task')/task/created))
                    ),
                    '-',
                    IF( hours-from-dateTime(instance('i-task')/task/created) &gt; 9,
                        hours-from-dateTime(instance('i-task')/task/created),
                        concat('0', hours-from-dateTime(instance('i-task')/task/created))
                    ),
                    IF( minutes-from-dateTime(instance('i-task')/task/created) &gt; 9,
                        minutes-from-dateTime(instance('i-task')/task/created),
                        concat('0', minutes-from-dateTime(instance('i-task')/task/created))
                    )
                    )" />
                <xf:message level="ephemeral" >Creating timestamp DONE <xf:output ref="instance('i-controller')/timestamp"/></xf:message>
            </xf:action>
            <xf:action ev:event="xforms-submit-done">
                <xf:message level="ephemeral">Data stored</xf:message>
                <xf:toggle case="default"/>
            </xf:action>
            <xf:action ev:event="xforms-submit-error" if="instance('i-controller')/error/@hasError='true'">
                <xf:setvalue ref="instance('i-controller')/error/@hasError" value="'true'"/>
                <xf:setvalue ref="instance('i-controller')/error" value="event('response-reason-phrase')"/>
                <!--<xf:setvalue ref="instance('i-controller')/error" value="'gabba'"/>-->
            </xf:action>
            <xf:action ev:event="xforms-submit-error" if="instance('i-controller')/error/@hasError='false'">
                <xf:message>The form has not been filled in correctly</xf:message>
            </xf:action>
        </xf:submission>
        <!-- Submission to receive all tasks allocated to a specified project -->
        <xf:submission id="s-get-tasks"
                       resource="http://golem.local:8080/exist/rest/db/test/timetracker.xql?project={instance('i-query-tasks')/project}"
                       method="post"
                       replace="instance"
                       instance="i-tasks"
                       validate="false">

            <xf:action ev:event="xforms-submit-done">
                <xf:message level="ephemeral">Received data from eXist DB</xf:message>
            </xf:action>
            <xf:message ev:event="xforms-submit-error">Failure received tasks froms eXist XML DB</xf:message>
        </xf:submission>

    </xf:model>
</div>



<div  style="width: 90%; height: 700px; padding: 10px;">

<div style="height: 50px;" >
    <div class="header">TimeTracker 0.2</div>
    <p>
        This result list should display check boxes, but displays text input fields.
    </p>
</div>

    <div style="padding:10px;height:90%;">
        <xf:group>
            <xf:label class="subheader">TimeTracker Results</xf:label>
            <table>
                <tr>
                    <td align="right">Project</td>
                    <td>
                        <xf:select1 id="projectToDisplay" ref="instance('i-query-tasks')/project" appearance="minimal">
                            <xf:label/>
                            <xf:itemset nodeset="instance('i-project')/project">
                                <xf:label ref="."/>
                                <xf:value ref="."/>
                            </xf:itemset>
                            <xf:send submission="s-get-tasks" ev:event="xforms-value-changed"
                                     if="string-length(instance('i-query-tasks')/project) &gt; 0"/>
                        </xf:select1>
                    </td>
                </tr>
            </table>

            <xf:output ref="instance('i-tasks')/project/duration">
                <xf:label>Overall Time:</xf:label>
            </xf:output>

            <xf:repeat nodeset="instance('i-tasks')/project/task" appearance="compact">
                <xf:output ref="date">
                    <xf:label>Date</xf:label>
                </xf:output>
                <xf:output
                        value="concat(format-number(duration/@hours,'00'),':',format-number(duration/@minutes, '00'))">
                    <xf:label>Duration</xf:label>
                </xf:output>
                <xf:output ref="who">
                    <xf:label>User(s)</xf:label>
                </xf:output>
                <xf:output ref="what">
                    <xf:label>Task</xf:label>
                </xf:output>
                <xf:output ref="note">
                    <xf:label>Note</xf:label>
                </xf:output>
                <xf:output ref="status">
                    <xf:label>Status</xf:label>
                </xf:output>
                <xf:input ref="billable">
                    <xf:label>Billable</xf:label>
                </xf:input>
            </xf:repeat>
        </xf:group>

    </div>

</div>


</body>
</html>

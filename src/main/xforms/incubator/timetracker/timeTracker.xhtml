<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xf="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.w3.org/2002/xforms ">
<head>
    <title>TimeTracker</title>

    <script type="text/javascript">
        dojo.require("dijit.dijit"); // optimize: load dijit layer
        dojo.require("dijit.layout.BorderContainer");
    </script>

    <style type="text/css">
        .header {
            font-size: 16pt;
            color: gray;
            border-bottom: thin solid gray;
        }

        tr.xfRepeatHeader  td {
            font-weight: bold;
            padding-right: 5px;
        }

        .caTabContainer {
            overflow: hidden;
        }

        tr.xfRepeatItem  td {
            padding-right: 5px;
        }

        /* date column */
        .caTableCol-1 {
            text-align: left;
            width: 11ex;
        }

        /* time column */
        .caTableCol-2 {
            text-align: right;
        }

        /* time column */
        .caTableCol-3 {
            text-align: left;
        }

        /* time column */
        .caTableCol-4 {
            text-align: left;
        }

        /* note column */
        .caTableCol-5 {
            overflow: hidden;
        }

        /* time column */
        .caTableCol-6 {
            text-align: left;
        }

        /* time column */
        .caTableCol-7 {
            text-align: right;
        }

        #task-table span.xfControl {
            display: block;
            margin-left: 5px;
        }

        /*.subheader {*/
            /*font-size: 14pt;*/
            /*color: gray;*/
            /*border-bottom: thin solid gray;*/
            /*margin-bottom: 30px;*/

        /*}*/

        /*.xfControl {*/
            /*padding: 4px;*/
        /*}*/

        /*#errorReport-value {*/
            /*border: thin solid;*/
            /*display: block;*/
            /*background: red;*/
        /*}*/

        /*#caCopyright {*/
            /*bottom: 5px;*/
        /*}*/
    </style>
</head>
<body>
<div style="display:none">
    <xf:model>

        <xf:instance id="i-task">
            <data xmlns="">
                <task>
                    <date/>
                    <project/>
                    <start/>
                    <end/>
                    <duration hours="0" minutes="0"/>
                    <who/>
                    <what/>
                    <note/>
                    <billable/>
                    <billed date=""/>
                    <status/>
                    <created/>
                </task>
            </data>
        </xf:instance>


        <xf:bind nodeset="task">
            <xf:bind nodeset="date" type="xf:date"/>
            <!--
				<xf:bind nodeset="start" type="xf:time" constraint=". &lt; ../end"/>
				<xf:bind nodeset="end" type="xf:time" constraint=". &gt; ../start"/>
-->
            <xf:bind nodeset="duration/@hours" type="integer" constraint=". != 0 or ../@minutes != 0"/>
            <xf:bind nodeset="duration/@minutes" type="integer" constraint=". != 0 or ../@hours != 0"/>
            <xf:bind nodeset="who" required="true()"/>
            <xf:bind nodeset="what" required="true()"/>
            <xf:bind nodeset="billable" type="xf:boolean"/>
            <xf:bind nodeset="billed" type="xf:boolean"/>
            <xf:bind nodeset="billed/@date" type="xf:date"/>
            <xf:bind nodeset="created" type="xf:dateTime" required="true()"/>
        </xf:bind>

        <xf:instance id="i-task-empty">
            <data xmlns="">
                <task>
                    <date/>
                    <project/>
                    <start/>
                    <end/>
                    <duration hours="0" minutes="0"/>
                    <who/>
                    <what/>
                    <note/>
                    <billable>false</billable>
                    <billed date=""/>
                    <status/>
                    <created/>
                </task>
            </data>
        </xf:instance>

        <xf:instance id="i-tasks">
            <data xmlns="">
            
            </data>
        </xf:instance>

        <xf:bind nodeset="instance('i-tasks')/project/task">
            <xf:bind nodeset="billable" type="boolean"/>
        </xf:bind>


        <xf:bind nodeset="instance('i-tasks')/project/task[1]/billable"
                 type="xf:boolean" />


        <xf:instance id="i-query-tasks">
            <data xmlns="">
                <project/>
                <worker/>
                <start/>
                <end/>
                <billable/>
            </data>
        </xf:instance>

        <xf:bind nodeset="instance('i-query-tasks')">
            <xf:bind nodeset="start"     type="xf:date" />
            <xf:bind nodeset="end"       type="xf:date" />
            <xf:bind nodeset="billable " type="xf:boolean" />
        </xf:bind>

        <xf:instance id="i-print-result">
            <data/>
        </xf:instance>

        <xf:instance id="i-project"
                     src="http://golem.local:8080/exist/rest/db/timetracking/i-project.xml"/>
        
        <xf:instance id="i-worker"
                     src="http://golem.local:8080/exist/rest/db/timetracking/i-worker.xml" />
        
        <xf:instance id="i-controller">
            <data xmlns="">
                <error hasError="false"><![CDATA[]]></error>
                <timestamp/>
            </data>
        </xf:instance>
        <xf:bind nodeset="instance('i-controller')/error" relevant="@hasError='true'"/>

        <xf:submission id="s-add"
                       resource="http://golem.local:8080/exist/rest/db/timetracking/tasks/task/{instance('i-controller')/timestamp}.xml"
                       method="put"
                       replace="none">
            <xf:action ev:event="xforms-submit">
                <xf:message level="ephemeral">Creating timestamp</xf:message>
                <xf:setvalue ref="instance('i-task')/task/created" value="adjust-dateTime-to-timezone(now())"/>
                <xf:setvalue ref="instance('i-controller')/timestamp" value="concat(
                    year-from-dateTime(instance('i-task')/task/created),
                    IF( month-from-dateTime(instance('i-task')/task/created) &gt; 9,
                        month-from-dateTime(instance('i-task')/task/created),
                        concat('0', month-from-dateTime(instance('i-task')/task/created))
                    ),
                    IF( day-from-dateTime(instance('i-task')/task/created) &gt; 9,
                        day-from-dateTime(instance('i-task')/task/created),
                        concat('0', day-from-dateTime(instance('i-task')/task/created))
                    ),
                    '-',
                    IF( hours-from-dateTime(instance('i-task')/task/created) &gt; 9,
                        hours-from-dateTime(instance('i-task')/task/created),
                        concat('0', hours-from-dateTime(instance('i-task')/task/created))
                    ),
                    IF( minutes-from-dateTime(instance('i-task')/task/created) &gt; 9,
                        minutes-from-dateTime(instance('i-task')/task/created),
                        concat('0', minutes-from-dateTime(instance('i-task')/task/created))
                    )
                    )" />
                <xf:message level="ephemeral" >Creating timestamp DONE <xf:output ref="instance('i-controller')/timestamp"/></xf:message>
            </xf:action>
            <xf:action ev:event="xforms-submit-done">
                <xf:message level="ephemeral">Data stored</xf:message>
                <xf:toggle case="default"/>
                <xf:send submission="s-clean"/>
            </xf:action>
            <xf:action ev:event="xforms-submit-error" if="instance('i-controller')/error/@hasError='true'">
                <xf:setvalue ref="instance('i-controller')/error/@hasError" value="'true'"/>
                <xf:setvalue ref="instance('i-controller')/error" value="event('response-reason-phrase')"/>
                <!--<xf:setvalue ref="instance('i-controller')/error" value="'gabba'"/>-->
            </xf:action>
            <xf:action ev:event="xforms-submit-error" if="instance('i-controller')/error/@hasError='false'">
                <xf:message>The form has not been filled in correctly</xf:message>
            </xf:action>
        </xf:submission>

        <xf:submission id="s-clean"
                       ref="instance('i-task-empty')"
                       resource="echo:foo"
                       method="get"
                       replace="instance"
                       instance="i-task"/>

        <!-- Submission to receive all tasks allocated to a specified project -->
        <xf:submission id="s-get-tasks"
                       resource="http://golem.local:8080/exist/rest/db/test/timetracker.xql?project={instance('i-query-tasks')/project}"
                       method="post"
                       replace="instance"
                       instance="i-tasks"
                       validate="false">

            <xf:action ev:event="xforms-submit-done">
                <xf:message level="ephemeral">Received data from eXist DB</xf:message>
            </xf:action>
            <xf:message ev:event="xforms-submit-error">Failure received tasks froms eXist XML DB</xf:message>
        </xf:submission>

        <!-- Submission to create HTML output for choosen tasks -->
        <xf:submission id="s-print-internal"
                       ref="instance('i-tasks')"
                       action="xslt:timetracker.xsl?nocache=true"
                       method="GET"
                       replace="instance"
                       instance="i-print-result"
                       validate="false">

            <xf:action ev:event="xforms-submit-done">
                <xf:recalculate/>
                <xf:send submission="s-save-in-webapp"/>
            </xf:action>
            <xf:message ev:event="xforms-submit-error">Failure transforming Tasks to HTML</xf:message>
        </xf:submission>

        <xf:submission id="s-print-customer"
                       ref="instance('i-tasks')"
                       action="xslt:timetrackerCustomers.xsl?nocache=true"
                       method="GET"
                       replace="instance"
                       instance="i-print-result"
                       validate="false">

            <xf:action ev:event="xforms-submit-done">
                <xf:recalculate/>
                <xf:send submission="s-save-in-webapp"/>
            </xf:action>
            <xf:message ev:event="xforms-submit-error">Failure transforming Tasks to HTML</xf:message>
        </xf:submission>

        <!-- Submission to write HTML output to the filesystem -->
        <xf:submission id="s-save-in-webapp"
                       action="{$webapp.realpath}/results.html"
                       method="put"
                       replace="none"
                       ref="instance('i-print-result')">
            <xf:action ev:event="xforms-submit-done">
                <xf:load resource="{$contextroot}/results.html" show="new"/>
            </xf:action>
            <xf:message ev:event="xforms-submit-error">Error while saving Test Restults in Webapp Directory</xf:message>
        </xf:submission>

        <xf:action ev:event="xforms-ready">
            <xf:setfocus control="date"/>
            <xf:setvalue ref="task/date" value="substring(now(),1,10)"/>
        </xf:action>

        <!-- create the i-who instance in the database -->
        <!--<xf:submission id="s-create-projects-instance"-->
                       <!--resource="http://golem.local:8080/exist/rest/db/timetracking/i-project.xml"-->
                       <!--method="put"-->
                       <!--ref="instance('i-project')"-->
                       <!--replace="none"-->
                       <!--validate="false"/>-->

    </xf:model>
</div>


<!--<div dojoType="dijit.layout.BorderContainer" design="sidebar" style="width: 90%; height: 700px; padding: 10px;">-->
<div  style="width: 90%; height: 700px; padding: 10px;">
<!--<div dojoType="dijit.layout.ContentPane" region="top" style="height: 50px;" splitter="false">-->
<div style="height: 50px;" >
    <div class="header">TimeTracker 0.2</div>
</div>

<!--<div dojoType="dijit.layout.ContentPane" region="center" style="padding:10px;height:90%;">-->
<div style="padding:10px;height:90%;">
    <xf:switch appearance="dijit:TabContainer" id="switch1" style="height:90%">
        <xf:case name="switch-toggles" id="switch-toggles" selected="false">
            <xf:trigger id="t-cTask">
                <xf:label/>
                <xf:toggle case="cTask"/>
            </xf:trigger>
            <xf:trigger id="t-cResults">
                <xf:label/>
                <xf:toggle case="cResults"/>
            </xf:trigger>
        </xf:case>

        <xf:case id="cTask" selected="true">
            <xf:label>Create</xf:label>
            <xf:group ref="task">
                <xf:label class="subheader">Create Task</xf:label>
                <table id="task-table" >
                    <tr>
                        <td align="right">Date</td>
                        <td>
                            <xf:input id="date" ref="date">
                                <xf:label/>
                            </xf:input>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">Project</td>
                        <td>
                            <xf:select1 id="project" ref="project" appearance="minimal">
                                <xf:label/>
                                <xf:itemset nodeset="instance('i-project')/project">
                                    <xf:label ref="."/>
                                    <xf:value ref="."/>
                                </xf:itemset>
                            </xf:select1>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">
                            Hours/Minutes
                        </td>
                        <td>
                            <xf:select1 ref="duration/@hours" style="float:left;">
                                <xf:label></xf:label>
                                <xf:item>
                                    <xf:label>0</xf:label>
                                    <xf:value>0</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>1</xf:label>
                                    <xf:value>1</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>2</xf:label>
                                    <xf:value>2</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>3</xf:label>
                                    <xf:value>3</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>4</xf:label>
                                    <xf:value>4</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>5</xf:label>
                                    <xf:value>5</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>6</xf:label>
                                    <xf:value>6</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>7</xf:label>
                                    <xf:value>7</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>8</xf:label>
                                    <xf:value>8</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>9</xf:label>
                                    <xf:value>9</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>10</xf:label>
                                    <xf:value>10</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>11</xf:label>
                                    <xf:value>11</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>12</xf:label>
                                    <xf:value>12</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>13</xf:label>
                                    <xf:value>13</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>14</xf:label>
                                    <xf:value>14</xf:value>
                                </xf:item>
                            </xf:select1>
                            <xf:select1 ref="duration/@minutes" appearance="mininmal">
                                <xf:label></xf:label>
                                <xf:item>
                                    <xf:label>0</xf:label>
                                    <xf:value>0</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>15</xf:label>
                                    <xf:value>15</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>30</xf:label>
                                    <xf:value>30</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>45</xf:label>
                                    <xf:value>45</xf:value>
                                </xf:item>
                            </xf:select1>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">Who</td>
                        <td>
                            <xf:select ref="who" appearance="full">
                                <xf:label></xf:label>
                                <xf:itemset nodeset="instance('i-worker')/worker">
                                    <xf:label ref="."/>
                                    <xf:value ref="."/>
                                </xf:itemset>
                            </xf:select>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">What</td>
                        <td>
                            <xf:select ref="what" appearance="full">
                                <xf:label></xf:label>
                                <xf:item>
                                    <xf:label>Bug Fix</xf:label>
                                    <xf:value>bugfix</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Feature</xf:label>
                                    <xf:value>feature</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Support</xf:label>
                                    <xf:value>support</xf:value>
                                </xf:item>
                            </xf:select>
                        </td>
                    </tr>

                    <tr>
                        <td align="right">Status</td>
                        <td>
                            <xf:select1 ref="status">
                                <xf:label></xf:label>
                                <xf:item>
                                    <xf:label/>
                                    <xf:value/>
                                </xf:item>
                                <xf:item>
                                    <xf:label>in progress</xf:label>
                                    <xf:value>inprogress</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>completed</xf:label>
                                    <xf:value>completed</xf:value>
                                </xf:item>
                            </xf:select1>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">Billable</td>
                        <td>
                            <xf:input ref="billable">
                                <xf:label></xf:label>
                                <xf:hint>True if task can be billed to Customer</xf:hint>
                            </xf:input>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">Note</td>
                        <td>
                            <xf:textarea ref="note" mediatype="dojo" style="width:200px;">
                                <xf:label></xf:label>
                                <xf:hint>What has been done?</xf:hint>
                            </xf:textarea>
                        </td>
                    </tr>
                    <tr>
                        <td align="right">
                            <xf:trigger style="padding-right:0;">
                                <xf:label>Add</xf:label>
                                <xf:toggle case="doIt"/>
                            </xf:trigger>
                        </td>
                        <td>
                            <!--Just for creating instances in eXist!-->
                            <!--<xf:trigger>-->
                                        <!--<xf:label>Create Projects Instance</xf:label>-->
                                        <!--<xf:send submission="s-create-projects-instance"/>-->
                                    <!--</xf:trigger>-->
                        </td>
                    </tr>
                </table>
                <xf:switch>
                    <xf:case id="default" selected="true"/>
                    <xf:case id="doIt">
                        <div style="font-weight:bold;">
                            Really add?
                        </div>
                        <table>
                            <tr>
                                <td>
                                    <xf:trigger>
                                        <xf:label>Yes</xf:label>
                                        <xf:send submission="s-add"/>
                                    </xf:trigger>
                                </td>
                                <td>
                                    <xf:trigger>
                                        <xf:label>Cancel</xf:label>
                                        <xf:toggle case="default"/>
                                    </xf:trigger>
                                </td>
                            </tr>
                        </table>

                    </xf:case>
                </xf:switch>
                <xf:output mediatype="text/html" ref="instance('i-controller')/error" id="errorReport"/>
            </xf:group>
        </xf:case>
        <xf:case id="cResults" selected="false">
        <xf:label>Listing</xf:label>
        <xf:group>
            <xf:label class="subheader">TimeTracker Results</xf:label>
            <table>
                <tr>
                    <td align="left">Project</td>
                    <td align="left">Worker</td>
                    <td align="left">Start</td>
                    <td align="left">End</td>
                    <td align="left">Billable</td>
                </tr>
                <tr>
                    <td>
                        <xf:select1 id="projectToDisplay" ref="instance('i-query-tasks')/project" appearance="minimal">
                            <xf:label/>
                            <xf:itemset nodeset="instance('i-project')/project">
                                <xf:label ref="."/>
                                <xf:value ref="."/>
                            </xf:itemset>
                        </xf:select1>
                    </td>
                    <td>
                        <xf:select1 id="personToDisplay" ref="instance('i-query-tasks')/worker" appearance="minimal">
                            <xf:label/>
                            <xf:itemset nodeset="instance('i-worker')/worker">
                                <xf:label ref="."/>
                                <xf:value ref="."/>
                            </xf:itemset>
                        </xf:select1>
                    </td>
                    <td>
                        <xf:input ref="instance('i-query-tasks')/start">
                            <xf:label/>
                        </xf:input>
                    </td>
                    <td>
                        <xf:input ref="instance('i-query-tasks')/end">
                            <xf:label/>
                        </xf:input>
                    </td>
                    <td>
                        <xf:input ref="instance('i-query-tasks')/billable">
                            <xf:label/>
                        </xf:input>
                    </td>
                </tr>
                <tr>
                    <td>
                        <xf:trigger>
                            <xf:label>Go</xf:label>
                                <xf:send submission="s-get-tasks"
                                         if="string-length(instance('i-query-tasks')/project) &gt; 0"/>
                        </xf:trigger>
                    </td>
                </tr>
            </table>

            <xf:output ref="instance('i-tasks')/project/duration">
                <xf:label>Overall Time:</xf:label>
            </xf:output>

            <xf:repeat nodeset="instance('i-tasks')/project/task" appearance="compact">
                <xf:output ref="date">
                    <xf:label>Date</xf:label>
                </xf:output>
                <xf:output value="concat(format-number(duration/@hours,'00'),':',format-number(duration/@minutes, '00'))">
                    <xf:label>Duration</xf:label>
                </xf:output>
                <xf:output ref="who">
                    <xf:label>User(s)</xf:label>
                </xf:output>
                <xf:output ref="what">
                    <xf:label>Task</xf:label>
                </xf:output>
                <xf:output ref="note">
                    <xf:label>Note</xf:label>
                </xf:output>
                <xf:output ref="status">
                    <xf:label>Status</xf:label>
                </xf:output>
                <xf:input ref="billable">
                    <xf:label>Billable</xf:label>
                </xf:input>

                <!--<xf:output ref="billable">-->
                    <!--<xf:label>Billable</xf:label>-->
                <!--</xf:output>-->
                <!--<xf:output ref="billed/@date">-->
                    <!--<xf:label>Billed</xf:label>-->
                <!--</xf:output>-->

            </xf:repeat>

            <xf:input ref="instance('i-tasks')/project/task[1]/billable">
                <xf:label>TEST</xf:label>
            </xf:input>

            <xf:trigger>
                <xf:label>Print Internal</xf:label>
                <xf:send submission="s-print-internal"/>
            </xf:trigger>
            <xf:trigger>
                <xf:label>Print Customer</xf:label>
                <xf:send submission="s-print-customer"/>
            </xf:trigger>
            <xf:output mediatype="text/html" ref="instance('i-controller')/error" id="errorReportResult"/>
        </xf:group>
     </xf:case>
  </xf:switch>
</div>

</div>


</body>
</html>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="fore-model.html">
<link rel="import" href="fore-input.html">

<script src="../bower_components/jquery/jquery.js"></script>
<script src="../bower_components/jquery-ui/ui/jquery-ui.js"></script>

<polymer-element name="fore-form" attributes="name dataformat mode instance" on-init-ui="initUI">
    <template class="foo">
        <!--<fore-model id="defaultModel" if="{{ createDefaultModel }}"></fore-model>-->
        <content></content>
    </template>
    <script>

        Polymer('fore-form', {
            dataformat:'json', //default format is JSON
            name:'data',
            xfModel:null,
            createDefaultModel:false,
            mode:'explicit',
            instance:'',


            created: function () {
                console.log("## FORE-FORM :: created : enhancing form : id=",this.id);
            },

            ready:function(){
                var inlineModel = this.querySelector('fore-model');

                // check for existence of inline model and create one if none existed
                if(inlineModel === null){
                    console.log("## FORE-FORM :: ready : !!! no inline model found - creating default model !!!");
                    var myModel = document.createElement('span','fore-model');
                    // $.defaultModel will not work with programmatically set ids - use this.querySelector('#defaultModel') instead
                    myModel.setAttribute('id','defaultModel');
                    //todo: jt: no idea why appending myModel to shadowRoot does not work here - shouldn't it be there?
                    this.appendChild(myModel);
                    //this.xfModel=myModel;
                    this.mode='implicit';
                } 

                this.createUI();

                /**
                 * triggers model construction when all components are ready.
                 */
                var that=this;
                window.addEventListener("WebComponentsReady", function(e){
                    console.log('## FORE-FORM :: WebComponentsReady - bootstrapping model construction');
                    console.log("name: ",that.name);
//                    console.log("name: ", that.$.defaultModel);
//                    that.$.defaultModel.fire('model-construct',{name:that.name,format:that.dataformat});
                      that.querySelector('fore-model').fire('model-construct',{name:that.name,format:that.dataformat});
                });

            },

            enteredView: function () {
                //var myModel = this.querySelector("fore-model");
                console.log("## FORE-FORM :: enteredView : xfModel ",this.xfModel);
                console.log("############# ");

                /*
                var controls = this.querySelectorAll('input');
                for (var i = 0; i < controls.length; i++) {
                    console.log("Control: ", controls[i]);
                    controls[i].fire('fore-bind', {});
//                    console.log("input init:", controls[i]);
//                    controls[i].bind('value', instance, 'foo2');
                }

                */
            },

            createUI: function () {
                console.log("FORM: ", this.getAttribute('id'), " createUI");
                var controls = this.querySelectorAll('input');
                for (var i = 0; i < controls.length; i++) {
                    controls[i].setAttribute('is', 'fore-input');
                    controls[i].ownerForm = this;
                }
            },

            initUI: function() {
                var controls = this.querySelectorAll('input');
                for (var i = 0; i < controls.length; i++) {
                    console.log("Control: ", controls[i]);
                    controls[i].fire('fore-bind', {form: this});
                }
            },

            leftView: function () {
            },
            attributeChanged: function (attrName, oldVal, newVal) {
            }

        });
    </script>
</polymer-element>
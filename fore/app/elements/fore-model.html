<link rel="import" href="fore-json-instance.html">
<link rel="import" href="fore-xml-instance.html">
<link rel="import" href="fore-bind.html">


<polymer-element name="fore-model" on-model-construct="{{ modelConstruct }}">
    <!--
    <template>
        <fore-instance id="defaultInstance"></fore-instance>
    </template>
    -->
    <template>
        <content></content>
    </template>

    <script>

        Polymer('fore-model', {
            ownerForm: null,
            states:[],


            ready: function () {
            },


            created: function () {
                console.log("### FORE-MODEL :: created : this=", this);
            },

            getInstance: function () {
                console.log(this);
                console.log("getInstance()");
                return document.getElementById('defaultInstance').getInstance();
            },
            enteredView: function () {
                this.ownerForm = this.parentNode;
                console.log("### FORE-MODEL :: enteredView : ownerform :", this.ownerForm);
//
//                this.ownerForm = this.parentNode.host;
//                console.log("fore ownerForm", this.ownerForm.name);
//
//                var formName = this.ownerForm.name;
//                console.log("### FORE-MODEL :: fore ownerForm : ", formName);

            },

            getOwnerForm: function () {
                return this.ownerForm;
            },

            /**
             * pre model construction tasks:
             * - resolution of linked instances
             * - construction of implied instance if any
             * @param e
             * @param details
             * @param sender
             */
            initFore:function(e,details,sender){
                //todo: move relevant code here.
            },

            modelConstruct: function (e, details, sender) {
                console.log("### FORE-MODEL :: model construct : event=", e);
                console.log("### FORE-MODEL :: model construct : name=", details.name);
                console.log("### FORE-MODEL :: shadowRoot", this.shadowRoot);
                console.log("### FORE-MODEL :: mode", this.ownerForm.mode);

                // todo: support multiple instances

                if(this.ownerForm.mode == 'implicit'){
                    var inst;
                    console.log("data format: ", this.ownerForm.dataformat);

                    if(this.ownerForm.dataformat === 'xml') {
                        inst = document.createElement('fore-instance', 'fore-xml-instance');
                        inst.setAttribute('instanceid', 'defaultInstance');
                        inst.setAttribute('dataformat', 'xml');
                        this.shadowRoot.appendChild(inst);

                        var data = document.createElement('data');
                        //var myInst = this.$.defaultInstance;
                        //myInst.appendChild(data);
                        inst.appendChild(data);
                        this.buildXMLInstance(this.ownerForm, data, this);

                    } else if(this.ownerForm.dataformat === 'json') {
                        inst = document.createElement('fore-instance', 'fore-json-instance');
                        inst.setAttribute('instanceid', 'defaultInstance');
                        inst.setAttribute('dataformat', 'json');
                        this.shadowRoot.appendChild(inst);

                        inst.data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm) + '}');
                        //console.log("JSON: ", this.$.defaultInstance.data);

                        console.log("JSON: ", inst.data);
                    }


/*
                    if (this.ownerForm.dataformat == 'xml') {
                        var data = document.createElement('data');
                        //var myInst = this.$.defaultInstance;
                        //myInst.appendChild(data);
                        inst.appendChild(data);
                        this.buildXMLInstance(this.ownerForm, data, this);
                    } else {
                        //this.$.defaultInstance.data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm) + '}');

                        inst.data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm) + '}');
                        //console.log("JSON: ", this.$.defaultInstance.data);

                        console.log("JSON: ", inst.data);
                    }
*/
                } else {
                    //todo: implement inline model initialization
                    console.log("to be implemented...");

                    this.querySelector('fore-instance').data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm) + '}');

                }


                //todo: detach model-construct listener
            },


            buildXMLInstance: function (node, instance, model) {
                //console.log("hazName: ", node.hasAttribute('name'));
                if (node.hasAttribute('name')) {
                    var name = node.getAttribute('name');
                    var value = node.getAttribute('value');
                    var instanceElement = document.createElement(name);

                    var bind = new ForeBind();
                    //document.createElement('span', 'fore-bind');
                    bind.setAttribute('ref', name);
//                    bind.setAttribute('debug', 'true');



                    //console.log("Name: ", node.getAttribute('name'));
                    //console.log("Value: ", node.getAttribute('value'));

                    var childNodes = node.children;
                    //console.log("L: ", childNodes.length);

                    if (childNodes.length == 0) {
                        if (value === null) {
                            value = '';
                        }
                        instanceElement.appendChild(document.createTextNode(value));
                    } else {
                        //console.log("loop");
                        for (var n = 0; n < childNodes.length; n++) {
                            this.buildXMLInstance(childNodes[n], instanceElement, bind);
                        }

                    }
                    instance.appendChild(instanceElement);
                    model.shadowRoot.appendChild(bind);
                } else {
                    var childNodes = node.children;

                    for (var n = 0; n < childNodes.length; n++) {
                        this.buildXMLInstance(childNodes[n], instance, model);
                    }
                }

            },

            buildJSONInstance: function (node) {
                //console.log("Name: ", node.getAttribute('name'));
                //console.log("Name: ", node.tagName);
                if (node.hasAttribute('name')) {
                    var nameName = node.getAttribute('name');
                    var value = node.getAttribute('value');

                    //console.log("Name: ", node.getAttribute('name'));
                    //console.log("Value: ", node.getAttribute('value'));

                    var childNodes = node.children;
                    //console.log("L: ", childNodes.length);

                    if (childNodes.length == 0) {
                        if (value == null) {
                            value = '';
                        }
                        return '"' + nameName + '":"' + value + '"';
                    } else {
//                        console.log("loop");
                        var result = '"' + nameName+ '":{';
                        for (var n = 0; n < childNodes.length; n++) {
                            if(childNodes[n].hasAttribute('name')) {
                                result += this.buildJSONInstance(childNodes[n]);
                                if (n < childNodes.length -1) {
                                    result += ',';
                                }
                            }
                        }
                        return result += '}';
                    }
                } else {
                    var childNodes = node.children;
                    var result = '';
                    for (var n = 0; n < childNodes.length; n++) {
                         result += this.buildJSONInstance(childNodes[n]);
                    }
                    return result;
                }

            }

        });
    </script>
</polymer-element>


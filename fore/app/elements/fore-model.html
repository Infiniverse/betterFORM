<link rel="import" href="fore-json-instance.html">
<link rel="import" href="fore-xml-instance.html">
<link rel="import" href="fore-bind.html">


<polymer-element name="fore-model" on-model-construct="{{ modelConstruct }}">
    <!--
    <template>
        <fore-instance id="defaultInstance"></fore-instance>
    </template>
    -->
    <template>
        <content></content>
    </template>

    <script>

        Polymer('fore-model', {
            isJSON: false,
            isMXL: true,
            modelId: 'd-model',
            ownerForm: this.parentNode,
            states:[],

            ready: function () {
                console.log("### FORE-MODEL :: ready");
            },


            created: function () {
                console.log("### FORE-MODEL :: created : this=", this);
            },

            getInstance: function () {
                console.log(this);
                console.log("getInstance()");
                return document.getElementById('defaultInstance').getInstance();
            },
            enteredView: function () {
                console.log("fore model parent", this.parentNode);
                this.ownerForm = this.parentNode.host;
                console.log("fore ownerForm", this.ownerForm.name);

                var formName = this.ownerForm.name;
                console.log("### FORE-MODEL :: fore ownerForm : ", formName);

            },

            getOwnerForm: function () {
                return this.ownerForm;
            },

            modelConstruct: function (e, details, sender) {
                console.log("### FORE-MODEL :: model construct : event=", e);
                console.log("### FORE-MODEL :: model construct : name=", details.name);



                console.log("### FORE-MODEL :: shadowRoot", this.shadowRoot);

                var inst;
                if(this.ownerForm.dataformat === 'xml') {
                    inst = document.createElement('fore-instance', 'fore-xml-instance');
                    inst.setAttribute('instanceid', 'defaultInstance');
                    inst.setAttribute('dataformat', 'xml');
                    this.shadowRoot.appendChild(inst);
                } else if(this.ownerForm.dataformat === 'json') {
                    inst = document.createElement('fore-instance', 'fore-json-instance');
                    inst.setAttribute('instanceid', 'defaultInstance');
                    inst.setAttribute('dataformat', 'json');
                    this.shadowRoot.appendChild(inst);
                }


                var controls = this.ownerForm.querySelectorAll('*[name]');

                console.log("controls: ", controls);
                console.log("data format: ", this.ownerForm.dataformat);

                if (this.ownerForm.dataformat == 'xml') {
                    var data = document.createElement('data');
                    //var myInst = this.$.defaultInstance;
                    //myInst.appendChild(data);
                    inst.appendChild(data);
                    this.buildXMLInstance(this.ownerForm, data, this);
                } else {
                    //this.$.defaultInstance.data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm) + '}');
                    inst.data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm) + '}');
                    //console.log("JSON: ", this.$.defaultInstance.data);
                    console.log("JSON: ", inst.data);
                }

            },

            buildXMLInstance: function (node, instance, model) {
                //console.log("hazName: ", node.hasAttribute('name'));
                if (node.hasAttribute('name')) {
                    var name = node.getAttribute('name');
                    var value = node.getAttribute('value');
                    var instanceElement = document.createElement(name);

                    var bind = new ForeBind();
                    //document.createElement('span', 'fore-bind');
                    bind.setAttribute('ref', name);



                    //console.log("Name: ", node.getAttribute('name'));
                    //console.log("Value: ", node.getAttribute('value'));

                    var childNodes = node.children;
                    //console.log("L: ", childNodes.length);

                    if (childNodes.length == 0) {
                        if (value === null) {
                            value = '';
                        }
                        instanceElement.appendChild(document.createTextNode(value));
                    } else {
                        //console.log("loop");
                        for (var n = 0; n < childNodes.length; n++) {
                            this.buildXMLInstance(childNodes[n], instanceElement, bind);
                        }

                    }
                    instance.appendChild(instanceElement);
                    model.shadowRoot.appendChild(bind);
                } else {
                    var childNodes = node.children;

                    for (var n = 0; n < childNodes.length; n++) {
                        this.buildXMLInstance(childNodes[n], instance, model);
                    }
                }

            },

            buildJSONInstance: function (node) {
                //console.log("Name: ", node.getAttribute('name'));
                //console.log("Name: ", node.tagName);
                if (node.hasAttribute('name')) {
                    var nameName = node.getAttribute('name');
                    var value = node.getAttribute('value');

                    //console.log("Name: ", node.getAttribute('name'));
                    //console.log("Value: ", node.getAttribute('value'));

                    var childNodes = node.children;
                    //console.log("L: ", childNodes.length);

                    if (childNodes.length == 0) {
                        if (value == null) {
                            value = '';
                        }
                        return '"' + nameName + '":"' + value + '"';
                    } else {
//                        console.log("loop");
                        var result = '"' + nameName+ '":{';
                        for (var n = 0; n < childNodes.length; n++) {
                            if(childNodes[n].hasAttribute('name')) {
                                result += this.buildJSONInstance(childNodes[n]);
                                if (n < childNodes.length -1) {
                                    result += ',';
                                }
                            }
                        }
                        return result += '}';
                    }
                } else {
                    var childNodes = node.children;
                    var result = '';
                    for (var n = 0; n < childNodes.length; n++) {
                         result += this.buildJSONInstance(childNodes[n]);
                    }
                    return result;
                }

            }

        });
    </script>
</polymer-element>


<link rel="import" href="fore-json-instance.html">
<link rel="import" href="fore-xml-instance.html">
<link rel="import" href="fore-bind.html">


<polymer-element name="fore-model" on-model-construct="{{ modelConstruct }}" on-model-construct-done="{{ modelConstructDone }}">
    <!--
    <template>
        <fore-instance id="defaultInstance"></fore-instance>
    </template>
    -->
    <template>
        <content></content>
    </template>

    <script>

        Polymer('fore-model', {
            ownerForm: null,
           
            ready: function () {
                this.states = []
                this.instances = [];
            },


            created: function () {
                console.log("### FORE-MODEL :: created : this=", this);
            },

            getInstance: function () {
                console.log(this);
                console.log("getInstance()");
                return document.getElementById('defaultInstance').getInstance();
            },
            
            getInstance: function (id) {
                return this.instances[id];
            },
            
            enteredView: function () {
                this.ownerForm = this.parentNode;
                console.log("### FORE-MODEL :: enteredView : ownerform :", this.ownerForm);
//
//                this.ownerForm = this.parentNode.host;
//                console.log("fore ownerForm", this.ownerForm.name);
//
//                var formName = this.ownerForm.name;
//                console.log("### FORE-MODEL :: fore ownerForm : ", formName);

            },

            getOwnerForm: function () {
                return this.ownerForm;
            },

            /**
             * pre model construction tasks:
             * - resolution of linked instances
             * - construction of implied instance if any
             * @param e
             * @param details
             * @param sender
             */
            initFore:function(e,details,sender){
                //todo: move relevant code here.
            },

            modelConstruct: function (e, details, sender) {
                console.log("### FORE-MODEL :: model construct : event=", e);
                console.log("### FORE-MODEL :: model construct : name=", details.name);
                console.log("### FORE-MODEL :: shadowRoot", this.shadowRoot);
                console.log("### FORE-MODEL :: mode", this.ownerForm.mode);
                //console.log("### FORE-MODEL :: instances", this.instances);

                // todo: support multiple instances

                if(this.ownerForm.mode === 'implicit'){
                    var inst;
                    console.log("data format: ", this.ownerForm.dataformat);

                    if(this.ownerForm.dataformat === 'xml') {
                        inst = document.createElement('fore-instance', 'fore-xml-instance');
                        if(this.ownerForm.instance === '') {
                            inst.setAttribute('id', 'defaultInstance');
                        } else {
                            inst.setAttribute('id', this.ownerForm.instance);
                        }
                        inst.setAttribute('dataformat', 'xml');
                        this.shadowRoot.appendChild(inst);

                        var data = document.createElement('data');
                        //var myInst = this.$.defaultInstance;
                        //myInst.appendChild(data);
                        inst.appendChild(data);
                        this.buildXMLInstance(this.ownerForm, data, this);
                        this.instances['defaultInstance'] = inst;

                    } else if(this.ownerForm.dataformat === 'json') {
                        inst = document.createElement('fore-instance', 'fore-json-instance');
                         if(this.ownerForm.instance === '') {
                            inst.setAttribute('id', 'defaultInstance');
                        } else {
                            inst.setAttribute('id', this.ownerForm.instance);
                        }
                        inst.setAttribute('dataformat', 'json');
                        this.shadowRoot.appendChild(inst);

                        inst.data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm, this) + '}');
                        //console.log("JSON: ", this.$.defaultInstance.data);
                        this.instances['defaultInstance'] = inst;
                        //console.log("JSON: ", inst.data);
                    }


/*
                    if (this.ownerForm.dataformat == 'xml') {
                        var data = document.createElement('data');
                        //var myInst = this.$.defaultInstance;
                        //myInst.appendChild(data);
                        inst.appendChild(data);
                        this.buildXMLInstance(this.ownerForm, data, this);
                    } else {
                        //this.$.defaultInstance.data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm) + '}');

                        inst.data = JSON.parse('{' + this.buildJSONInstance(this.ownerForm) + '}');
                        //console.log("JSON: ", this.$.defaultInstance.data);

                        console.log("JSON: ", inst.data);
                    }
*/
                } else {
                    //todo: implement inline model bind initialization
                    console.log("to be implemented...");
                    
                    var foreInstances = this.querySelectorAll('fore-json-instance');
                    //console.log("foreInstances:" , foreInstances);
                    for(var j = 0; j < foreInstances.length; j++) {
                        //console.log("fore-instance ID:" , foreInstances[j].getAttribute('id'));
                        var data = foreInstances[j].textContent;
                        foreInstances[j].setAttribute('dataformat', 'json');
                        foreInstances[j].data = JSON.parse(data);
                        this.instances[foreInstances[j].getAttribute('id')] = foreInstances[j];
                        //this.querySelector('fore-instance').data = JSON.parse(data);
                    }
                    //console.log("foreInstances:" ,this.instances);
                }

                this.ownerForm.xfModel=this;
                //todo: detach model-construct listener
                this.fire('model-construct-done',{});
            },
            
            modelConstructDone: function (e, details, sender) {
                console.log("Model: ", this.getAttribute('id'), " model-construct-done");
            },


            buildXMLInstance: function (node, instance, model) {
                //console.log("hazName: ", node.hasAttribute('name'));
                if (node.hasAttribute('name')) {
                    var name = node.getAttribute('name');
                    var value = node.getAttribute('value');
                    var instanceElement = document.createElement(name);

                    var bind = this.buildForeBind(node);
                    //console.log("Name: ", node.getAttribute('name'));
                    //console.log("Value: ", node.getAttribute('value'));

                    var childNodes = node.children;
                    //console.log("L: ", childNodes.length);

                    if (childNodes.length === 0) {
                        if (value === null) {
                            value = '';
                        }
                        instanceElement.appendChild(document.createTextNode(value));
                    } else {
                        //console.log("loop");
                        for (var n = 0; n < childNodes.length; n++) {
                            this.buildXMLInstance(childNodes[n], instanceElement, bind);
                        }

                    }
                    instance.appendChild(instanceElement);
                    model.shadowRoot.appendChild(bind);
                } else {
                    var childNodes = node.children;

                    for (var n = 0; n < childNodes.length; n++) {
                        this.buildXMLInstance(childNodes[n], instance, model);
                    }
                }

            },

            buildJSONInstance: function (node, model) {
                //console.log("Name: ", node.getAttribute('name'));
                //console.log("Name: ", node.tagName);
                if (node.hasAttribute('name')) {
                    var nameName = node.getAttribute('name');
                    var value = node.getAttribute('value');

                    //console.log("Name: ", node.getAttribute('name'));
                    //console.log("Value: ", node.getAttribute('value'));

                    var childNodes = node.children;
                    //console.log("L: ", childNodes.length);

                    var bind = this.buildForeBind(node);
                    if (childNodes.length === 0) {
                        if (value === null) {
                            value = '';
                        }
                        
                        model.shadowRoot.appendChild(bind);
                        return '"' + nameName + '":"' + value + '"';
                    } else {
//                        console.log("loop");
                        var result = '"' + nameName+ '":{';
                        for (var n = 0; n < childNodes.length; n++) {
                            if(childNodes[n].hasAttribute('name')) {
                                result += this.buildJSONInstance(childNodes[n], bind);
                                if (n < childNodes.length -1) {
                                    result += ',';
                                }
                            }
                        }
                        
                        model.shadowRoot.appendChild(bind);                        
                        return result += '}';
                    }
                } else {
                    var childNodes = node.children;
                    var result = '';
                    for (var n = 0; n < childNodes.length; n++) {
                         result += this.buildJSONInstance(childNodes[n], model);
                    }
                    return result;
                }

            },
            
            buildForeBinds: function (node, model) {
                if (node.hasAttribute('name')) {
                    var bind = this.buildForeBind(node);
                    var childNodes = node.children;
                    for (var n = 0; n < childNodes.length; n++) {
                        this.buildForeBinds(childNodes[n], bind);
                    }
                    model.shadowRoot.appendChild(bind);
                } else {
                    var childNodes = node.children;
                    for (var n = 0; n < childNodes.length; n++) {
                        this.buildForeBinds(childNodes[n], model);
                    }
                }
            },
            
            buildForeBind: function (node) {
                var bind = new ForeBind();
                bind.ref = node.getAttribute('name');
                bind.debug = false;

                if(node.hasAttribute('type')) {
                    if( node.getAttribute('type') === 'text') {
                        bind.datatype = 'string'; 
                    } else {
                        bind.datatype = node.getAttribute('type'); 
                    }
                }        
                if(node.hasAttribute('calculate')) {
                   bind.calculate = node.getAttribute('calculate'); 
                }
                if(node.hasAttribute('readonly')) {
                    bind.readonly = node.getAttribute('readonly');
                }
                if(node.hasAttribute('required')) {
                    bind.required = node.getAttribute('required');
                }
                if(node.hasAttribute('relevant')) {
                   bind.relevant = node.getAttribute('relevant'); 
                }
                return bind;
            }

        });
    </script>
</polymer-element>


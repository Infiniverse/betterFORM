<project name="betterFORM XRX deployer" default="install" basedir="../">

    <xmlproperty file="../../build.properties.xml" semanticAttributes="true" keepRoot="false"/>
    <property name="exist.dir" value="/Users/dev/projects/eXist"/>

    <target name="clean">
        <delete dir="${basedir}/target"/>
    </target>

    <condition property="eXist-1.4">
        <equals arg1="${installer.exist.version}" arg2="1.4"/>
    </condition>

    <condition property="eXist-1.5">
        <equals arg1="${installer.exist.version}" arg2="1.5"/>
    </condition>

    <target name="bootstrap">
        <java jar="${installer.exist.jar}" fork="true" spawn="false" failonerror="true">
            <arg line="-p ${exist.dir}"/>
        </java>
        
        <antcall target="install"/>
    </target>
    
    
    <target name="install">
        <mkdir dir="${exist.dir}/extensions/betterform"/>

        <ant dir="${basedir}" antfile="../build-betterFORM-XRX.xml" target="build-up-to-date-extension"/>

        <antcall target="copyExtension"/>


        <ant dir="${exist.dir}/extensions/betterform" antfile="${exist.dir}/extensions/betterform/build.xml" target="wrapped-install"/>
        <ant dir="${exist.dir}/extensions/betterform" antfile="${exist.dir}/extensions/betterform/build.xml" target="install-betterFORM-XRX-Sample"/>
    </target>

    <target  name="start-eXist">
        <echo  message="*******************************************************************************"/>
        <echo  message="* Starting eXist-DB                                                           *"/>
        <echo  message="*******************************************************************************"/>


        <exec executable="${exist.dir}/bin/startup.sh" osfamily="unix" spawn="true"/>

        <exec executable="cmd" osfamily="windows" spawn="true">
            <arg value="/c"/>
            <arg value="${exist.dir}/bin/startup.bat"/>
        </exec>

        <sleep seconds="30"/>
    </target>

    <target name="stop-eXist">
        <echo  message="*******************************************************************************"/>
        <echo  message="* Stopping eXist-DB                                                           *"/>
        <echo  message="*******************************************************************************"/>

        <sleep seconds="10"/>

        <exec executable="${exist.dir}/bin/shutdown.sh" osfamily="unix">
            <arg value="-p"/>
           <arg value="${installer.exist.passwd}"/>
        </exec>
        <exec executable="cmd" osfamily="windows">
            <arg value="/c"/>
            <arg value="${exist.dir}/bin/shutdown.bat"/>
            <arg value="-p"/>
            <arg value="${installer.exist.passwd}"/>
        </exec>
    </target>

    <target  name="copyExtension" depends="set-extension-dir">
        <copy todir="${exist.dir}/extensions/">
            <fileset dir="${extension.dir}"/>
        </copy>
    </target>

    <target name="set-extension-dir" depends="set-extension-dir-1.4, set-extension-dir-1.5"/>

    <target name="set-extension-dir-1.4" if="eXist-1.4">
        <property name="extension.dir" value="${basedir}/target/eXist-1.4"/>
    </target>

    <target name="set-extension-dir-1.5" if="eXist-1.5">
        <property name="extension.dir" value="${basedir}/target/eXist-1.5"/>
    </target>
</project>

<project name="Installer" default="createInstaller" basedir=".">

    <xmlproperty file="../../build.properties.xml" semanticAttributes="true" keepRoot="false"/>


    <target name="clean">
        <delete dir="${basedir}/target"/>
    </target>
    <target name="prepare" description="prepares all files needed for installer EXCEPT exist.war">
        <!-- ##### building betterForm war for deployment ##### -->
        <ant antfile="../../web/build.xml" target="package" inheritall="false">
        </ant>

        <mkdir dir="${basedir}/target"/>
        
        <copy todir="${basedir}/target">
            <fileset file="${basedir}/../../web/target/${web.app.name}-${web.app.version}.war"/>
        </copy>
        <move file="${basedir}/target/${web.app.name}-${web.app.version}.war" tofile="${basedir}/target/betterform.war"/>

        <copy todir="${basedir}/target">
            <fileset file="${basedir}/../../src/main/license/BSD-license.txt"/>
        </copy>


        <!-- #### get and unpack dojo -->
        <gunzip dest="${basedir}/target/${properties.dojo}.tar" src="${basedir}/../../src/main/lib/${properties.dojo}.tar.gz"/>
        <untar  dest="${basedir}/target/dojo-release" src="${basedir}/target/${properties.dojo}.tar"/>
        <move  file="${basedir}/target/dojo-release/${properties.dojo}" todir="${basedir}/target"/>
        <delete dir="${basedir}/target/dojo-release" />
        <delete file="${basedir}/target/${properties.dojo}.tar" />


        <!--##### fetching jetty from remote ##### -->
        <get usetimestamp="true" ignoreerrors="true" src="http://dist.codehaus.org/jetty/jetty-6.1.22/jetty-6.1.22.zip"
             dest="${basedir}/target/jetty.zip"/>



        <!--##### unpacking jetty can move it into a subfolder  - rename it to betterform ##### -->
        <unzip src="${basedir}/target/jetty.zip"
               dest="${basedir}/target/jetty" />

<!--
        <ant antfile="${basedir}/../server/build.xml" target="package" inheritall="false"/>
        <move  file="${basedir}/../server/target/server/betterform" tofile="${basedir}/target/jetty/betterform"/>
-->
        <move file="${basedir}/target/jetty/jetty-6.1.22" tofile="${basedir}/target/jetty/betterform"/>

    </target>

    <target name="betterFormWarInstaller"
            description="Builds a betterForm Installer for deploying existing webcontainer">


        <!-- Allows us to use the IzPack Ant task -->
        <taskdef name="izpack"
                 classpath="${basedir}/lib/standalone-compiler.jar"
                 classname="com.izforge.izpack.ant.IzPackTask"/>

        <!-- We call IzPack -->
        <echo message="Makes the installer using IzPack"/>

<!--
        <izpack input="${basedir}/installer.xml"
                output="${basedir}/target/betterform-install.jar"
                installerType="web"
                basedir="${basedir}/target"/>
-->
        <izpack input="${basedir}/installer.xml"
                output="${basedir}/target/betterform-install.jar"
                installerType="standard"
                basedir="${basedir}/target"/>

        <chmod file="${basedir}/target/betterform-install.jar" perm="770"/>

    </target>



    

</project>

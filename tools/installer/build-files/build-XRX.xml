<!--
  ~ Copyright (c) 2012. betterFORM Project - http://www.betterform.de
  ~ Licensed under the terms of BSD License
  -->

<project name="Installer-eXist" default="create-XRX" basedir=".">
    <property name="eXist.stable.src" value="http://downloads.sourceforge.net/project/exist/Stable/2.0/eXist-setup-2.0-tech-preview.jar"/>
    <property name="eXist.dev.src" value="http://downloads.sourceforge.net/project/exist/Stable/1.4.2/eXist-setup-1.4.2dev-rev15584.jar"/>

    <property name="eXist.db.user" value="betterFORM"/>
    <property name="eXist.db.passwd" value="Tha0xeiC8a"/>

    <available property="eXist-stable-available" file="${installer.utils}/exist-install-stable.jar"/>
    <available property="eXist-dev-available" file="${installer-utils}/exist-install-dev.jar"/>

    <xmlproperty file="../../../build.properties.xml" semanticAttributes="true" keepRoot="false"/>

    <condition property="eXist-stable">
        <equals arg1="${installer.exist.version}" arg2="stable"/>
    </condition>

    <condition property="eXist-dev">
        <equals arg1="${installer.exist.version}" arg2="dev"/>
    </condition>

    <!-- Download eXist installer dependent on version -->
    <target name="get-eXist">
        <mkdir dir="${installer.utils}"/>
        <antcall target="get-and-set-eXist-stable-installer"/>
        <antcall target="get-and-set-eXist-dev-installer"/>
    </target>

    <target name="get-and-set-eXist-stable-installer" if="eXist-stable">
        <antcall target="get-eXist-stable"/>
        <copy file="${installer.utils}/exist-install-stable.jar" tofile="${installer.target}/exist-install.jar" description="setting eXist installer to stable version"/>
    </target>

    <target name="get-eXist-stable" if="eXist-stable" unless="eXist-stable-available">
        <get src="${eXist.stable.src}" dest="${installer.utils}/exist-install-stable.jar" description="downloads eXist stable installer"/>
    </target>

    <target name="get-and-set-eXist-dev-installer" if="eXist-dev">
        <antcall target="get-eXist-dev"/>
        <copy file="${installer.utils}/exist-install-dev.jar" tofile="${installer.target}/exist-install.jar" description="setting eXist installer to development version"/>
    </target>

    <target name="get-eXist-dev" if="eXist-dev" unless="eXist-dev-available">
        <get src="${eXist.dev.src}" dest="${installer.utils}/exist-install-dev.jar" description="downloads eXist dev installer"/>
    </target>

    <target name="setupBetterFORMUser">
        <antcall target="build-SetupBetterFORMUserJar" inheritrefs="true"/>
        <copy file="${installer.target}/betterFORM-Setup.jar" todir="${installer.target}/bf-XRX/" overwrite="true"/>


        <ant antfile="${xrx.dir}/build-utils-eXist.xml" target="start-eXist">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
        </ant>



        <java jar="${installer.target}/bf-XRX/betterFORM-Setup.jar"
              fork="true"
              dir="${installer.target}/bf-XRX"
              maxmemory="512m"
              failonerror="true"/>

        <delete file="${installer.target}/bf-XRX/betterFORM-Setup.jar"/>


        <!-- Wait for db-shutdown -->
        <sleep seconds="20"/>
    </target>


    <target name="build-SetupBetterFORMUserJar">
        <echo message="*******************************************************************************"/>
        <echo message="* Building betterFORM-Setup.jar                                               *"/>
        <echo message="*******************************************************************************"/>
        <mkdir dir="${installer.target}/classes"/>

        <javac description="compile source files"
               srcdir="${basedir}/src/main/java"
               destdir="${installer.target}/classes"
               classpathref="installer.class.path"
               target="${properties.javac.version}"
               debug="${properties.javac.debug}"
               deprecation="${properties.javac.deprecation}"
               optimize="${properties.javac.optimize}"/>

        <jar description="package betterform jar"
             jarfile="${installer.target}/betterFORM-Setup.jar"
             basedir="${installer.target}/classes"
             manifest="${basedir}/src/main/resources/MANIFEST.MF"/>
    </target>

    <target name="create-XRX" depends="get-eXist">
        <echo>
            __== Creating XRX-environment for Installer ==__
        </echo>


        <delete dir="${installer.target}/bf-XRX/"/>
        <mkdir dir="${installer.target}/bf-XRX/"/>

        <!-- Install eXist-db to target -->
        <java jar="${installer.target}/exist-install.jar"
              fork="true"
              maxmemory="512m"
              spawn="false" failonerror="true">
            <arg line="-p ${installer.target}/bf-XRX/"/>
        </java>

        <delete file="${installer.target}/bf-XRX/Install_*.log"/>

        <!-- Create an 'betterFORM'-DB-User for storing stuff -->
        <!-- See eXist-build-file for password -->

        <antcall target="setupBetterFORMUser" inheritrefs="true"/>

        <ant antfile="${xrx.dir}/build-XRX.xml" target="update-betterFORM" inheritall="false" usenativebasedir="true">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
            <property name="eXist.db.user" value="${eXist.db.user}"/>
            <property name="eXist.db.passwd" value="${eXist.db.passwd}"/>
        </ant>

        <ant antfile="${xrx.dir}/build-utils-eXist.xml" target="start-eXist">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
        </ant>

        <ant antfile="${xrx.dir}/build-XRX.xml" target="install-forms" inheritall="false" usenativebasedir="true">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
            <property name="eXist.db.user" value="${eXist.db.user}"/>
            <property name="eXist.db.passwd" value="${eXist.db.passwd}"/>
        </ant>


        <ant antfile="${xrx.dir}/build-XRX.xml" target="install-demo-xrx-betterFORM-user" inheritall="false" usenativebasedir="true">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
            <property name="eXist.db.user" value="${eXist.db.user}"/>
            <property name="eXist.db.passwd" value="${eXist.db.passwd}"/>
        </ant>

        <ant antfile="${xrx.dir}/build-XRX.xml" target="install-dashboard" inheritall="false" usenativebasedir="true">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
            <property name="eXist.db.user" value="${eXist.db.user}"/>
            <property name="eXist.db.passwd" value="${eXist.db.passwd}"/>
        </ant>

	<!--
        <ant antfile="${xrx.dir}/build-XRX.xml" target="install-editor" inheritall="false" usenativebasedir="true">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
            <property name="eXist.db.user" value="${eXist.db.user}"/>
            <property name="eXist.db.passwd" value="${eXist.db.passwd}"/>
        </ant>
	-->

        <ant antfile="${xrx.dir}/build-utils-eXist.xml" target="stop-eXist">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
        </ant>

        <ant antfile="${xrx.dir}/build-XRX.xml" target="setup-betterFORM-context" inheritall="false" usenativebasedir="true">
            <property name="eXist.home" value="${installer.target}/bf-XRX/"/>
        </ant>

        <!-- Copy template-files which will be modified by the Installer-->

        <copy todir="${installer.target}/bf-XRX/bin" overwrite="true">
            <fileset dir="${installer.target}/bf-XRX/installer/scripts" includes="*.sh *.bat" excludes="build.*"/>
        </copy>

        <copy todir="${installer.target}/bf-XRX" overwrite="true">
            <fileset dir="${installer.target}/bf-XRX/installer/scripts" includes="build.sh build.bat"/>
        </copy>

        <!-- Copy wrapper.conf template refuses to be overriden by installer -->
        <delete file="${installer.target}/bf-XRX/tools/wrapper/conf/wrapper.conf"/>
        <copy tofile="${installer.target}/bf-XRX/tools/wrapper/conf/wrapper.conf" file="${installer.target}/bf-XRX/tools/wrapper/conf/wrapper.conf.install" overwrite="true"/>


	    <unzip src="${basedir}/lib/betterFORM-Launcher-1.4-xrx-distribution.zip" dest="${installer.target}/bf-XRX"/>
        <move file="${installer.target}/bf-XRX/betterFORM-Launcher-1.4.jar" tofile="${installer.target}/bf-XRX/betterFORM.jar"/>

    </target>
</project>
